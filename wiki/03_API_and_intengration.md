
# API и интеграции системы «Умная премия»

## 1. Авторизация

### 1.1 Telegram WebApp

* Используется `initData` для верификации пользователя.
* Backend проверяет подпись `hash` и идентифицирует пользователя.
* После успешной проверки создается сессия (JWT или cookie).

### 1.2 Корпоративный аккаунт (опционально)

* OAuth2 / SSO.
* Получение токена доступа для API.

---

## 2. Входные переменные премии

Для расчёта премии используются следующие параметры:

| Переменная                 | Описание                                        | Пример                                           |
| -------------------------- | ----------------------------------------------- | ------------------------------------------------ |
| `average_weekly_revenue`   | Средняя недельная выручка за последние 3 недели | 3057926.67                                       |
| `participation_multiplier` | Умножитель участия (доля участников команды)    | 0.875                                            |
| `total_weekly_bonus`       | Общая сумма недельной премии                    | 37459.60                                         |
| `participants`             | Информация о сотрудниках                        | `{"total_potential":32,"refused":4,"active":28}` |

Эти данные передаются при расчёте премии каждого сотрудника с учётом оценок.

---

## 3. Эндпоинты фронтенд → backend

### 3.0 Получение текущей сессии (веб/мобильный клиент)

* **URL:** `/api/v1/sessions/current`
* **Метод:** GET
* **Описание:** Получение активной сессии голосования.
* **Ответ:**

```json
{
  "session_id": 17,
  "start_date": "2025-10-20",
  "end_date": "2025-10-26",
  "active": true
}
```

---

### 3.1 Голосование

* **URL:** `/api/v1/votes`
* **Метод:** POST
* **Описание:** Отправка оценок за коллег (включая себя)
* **Запрос:**

```json
{
  "session_id": 17,
  "votes": [
    {"user_id": 101, "score": 8},
    {"user_id": 102, "score": 7},
    {"user_id": 103, "score": 9}
  ],
  "participants_info": {
    "average_weekly_revenue": 3057926.67,
    "participation_multiplier": 0.875,
    "total_weekly_bonus": 37459.60,
    "participants": {"total_potential":32,"refused":4,"active":28}
  }
}
```

* **Ответ:**

```json
{
  "status": "success",
  "message": "Оценки сохранены"
}
```

#### Пояснения:

1. `voter_id` определяется **из аутентификационных данных**, а не из JSON:

   * Telegram WebApp: `user.id` из `initData`
   * Веб: JWT / корпоративная сессия
2. Backend проверяет:

   * Активность сессии (`session_id`)
   * Пользователь ещё не голосовал за этих коллег
   * Голос в диапазоне 0–10
3. После сохранения голосов происходит **расчёт промежуточных и итоговых баллов**, аналогично листам `_T1`–`_T4` в Excel:

   * `_T1` – сбор оценок по критериям
   * `_T2` – вычисление средней моды / базовой шкалы
   * `_T3` – нормализация и подсчёт очков
   * `_T4` – финальная корректировка и проверка
4. Итоговая премия вычисляется пропорционально баллам, с учётом `total_weekly_bonus` и `participation_multiplier`.

---

### 3.2 Просмотр результатов (сотрудник)

* **URL:** `/api/v1/results/me`
* **Метод:** GET
* **Описание:** Получение собственного рейтинга и премии
* **Ответ:**

```json
{
  "user_id": 101,
  "average_score": 7.8,
  "rank": 3,
  "total_bonus": 1541.81,
  "votes_given": 5,
  "votes_received": [
    {"from_user_id": 102, "score": 8},
    {"from_user_id": 103, "score": 7}
  ]
}
```

---

### 3.3 Просмотр результатов (админ)

* **URL:** `/api/v1/results/session/{session_id}`
* **Метод:** GET
* **Описание:** Получение всех голосов и распределения премий за сессию
* **Ответ:**

```json
{
  "session_id": 17,
  "results": [
    {
      "user_id": 101,
      "average_score": 7.8,
      "votes_received": 5,
      "total_bonus": 1541.81
    },
    {
      "user_id": 102,
      "average_score": 8.2,
      "votes_received": 5,
      "total_bonus": 1600.45
    }
  ]
}
```

---

## 4. Управление сессиями (админ)

### 4.1 Создание новой сессии

* **URL:** `/api/v1/sessions`
* **Метод:** POST
* **Запрос:**

```json
{
  "start_date": "2025-10-20",
  "end_date": "2025-10-26",
  "active": true
}
```

* **Ответ:**

```json
{
  "status": "success",
  "session_id": 17
}
```

### 4.2 Закрытие сессии

* **URL:** `/api/v1/sessions/{session_id}/close`
* **Метод:** POST
* **Ответ:**

```json
{
  "status": "success",
  "message": "Сессия закрыта"
}
```

---

## 5. Управление участниками (админ)

### 5.1 Добавление / обновление сотрудника

* **URL:** `/api/v1/users`
* **Метод:** POST
* **Запрос:**

```json
{
  "user_id": 101,
  "name": "Иван Иванов",
  "active": true
}
```

* **Ответ:**

```json
{
  "status": "success",
  "message": "Пользователь добавлен/обновлён"
}
```

### 5.2 Пометка сотрудника как неактивного

* **URL:** `/api/v1/users/{user_id}/deactivate`
* **Метод:** POST
* **Ответ:**

```json
{
  "status": "success",
  "message": "Пользователь помечен как неактивный"
}
```

---

## 6. Экспорт данных (админ)

* **URL:** `/api/v1/export/session/{session_id}`
* **Метод:** GET
* **Описание:** Получение XLSX или CSV с итогами голосования и премиями
* **Ответ:** файл для скачивания, включая расчётные колонки:

  * `ФИО`
  * `Средняя оценка`
  * `Итоговая премия`
  * `Ранг`
  * `Баллы по критериям`

---

## 7. Безопасность

* Все эндпоинты требуют аутентификации (JWT или сессия)
* Разграничение ролей: сотрудник / админ
* Валидация всех входных данных
* Проверка подписи Telegram для предотвращения подделки голосов
* Проверка `session_id` на активность перед принятием голосов

---

## 8. Интеграции

* Telegram Mini App → Frontend → Backend API
* Опциональная интеграция с корпоративной SSO
* Экспорт данных для бухгалтерии и HR-систем (XLSX/CSV)
* Асинхронные уведомления через Telegram / email

---

## 9. Пример потока голосования

1. Frontend делает GET `/sessions/current` → получает `session_id`.
2. Пользователь открывает форму голосования и ставит оценки коллегам.
3. Frontend отправляет POST `/votes` с `session_id`, оценками и параметрами премии.
4. Backend:

   * Определяет `voter_id`
   * Проверяет активность сессии и участников
   * Сохраняет оценки
   * Выполняет расчёт промежуточных таблиц `_T1`–`_T4`
   * Вычисляет итоговую премию пропорционально баллам и `total_weekly_bonus`
5. После окончания недели админ получает GET `/results/session/{session_id}` и может экспортировать XLSX/CSV.

---
## 10. Структура JSON для расчёта премий (_T1–_T4)


### 1. Общие параметры

```json
{
  "average_weekly_revenue": 3057926.67,
  "participation_multiplier": 0.875,
  "total_weekly_bonus": 37459.60,
  "participants_info": {
    "total_potential": 32,
    "refused": 4,
    "active": 28
  }
}
```

---

### 2. Сырые оценки (`_T1`)

* Оценки сотрудников по различным критериям (участие, присутствие, качество и т.д.)
* Каждому участнику соответствует словарь с оценками по другим участникам.

```json
{
  "T1": {
    "Александров Евгений": {
      "Александров Евгений": 10,
      "Алексеев Дмитрий": 0,
      "Батманов Павел": 5
    },
    "Алексеев Дмитрий": {
      "Александров Евгений": 0,
      "Алексеев Дмитрий": 0,
      "Батманов Павел": 0
    },
    "Батманов Павел": {
      "Александров Евгений": 5,
      "Алексеев Дмитрий": 0,
      "Батманов Павел": 5
    }
  }
}
```

---

### 3. Средние значения и базовая шкала (`_T2`)

* Здесь вычисляется средняя модальная оценка для каждого участника.

```json
{
  "T2": {
    "Александров Евгений": 7.5,
    "Алексеев Дмитрий": 0,
    "Батманов Павел": 5.0
  }
}
```

* Эти значения используются для нормализации итоговых баллов.

---

### 4. Нормализованные баллы (`_T3`)

* Переводим оценки в единый формат для суммирования и пропорционального распределения премии.

```json
{
  "T3": {
    "Александров Евгений": 8.5,
    "Алексеев Дмитрий": 0,
    "Батманов Павел": 6.0
  }
}
```

---

### 5. Финальные корректировки (`_T4`)

* Применение дополнительных коэффициентов (например, участие, корректировка за отсутствие)

```json
{
  "T4": {
    "Александров Евгений": 8.5,
    "Алексеев Дмитрий": 0,
    "Батманов Павел": 5.5
  }
}
```

---

### 6. Итоговая премия

* Распределение `total_weekly_bonus` пропорционально итоговым баллам `_T4`.

```json
{
  "final_bonus": {
    "Александров Евгений": 1541.81,
    "Алексеев Дмитрий": 0,
    "Батманов Павел": 1445.45
  }
}
```

---

### 7. Пример полного запроса API для расчёта премии

```json
{
  "session_id": 17,
  "participants_info": {
    "average_weekly_revenue": 3057926.67,
    "participation_multiplier": 0.875,
    "total_weekly_bonus": 37459.60,
    "participants": {"total_potential":32,"refused":4,"active":28}
  },
  "votes": {
    "T1": {
      "Александров Евгений": {"Александров Евгений":10,"Алексеев Дмитрий":0,"Батманов Павел":5},
      "Алексеев Дмитрий": {"Александров Евгений":0,"Алексеев Дмитрий":0,"Батманов Павел":0},
      "Батманов Павел": {"Александров Евгений":5,"Алексеев Дмитрий":0,"Батманов Павел":5}
    }
  }
}
```

* Backend принимает этот JSON и последовательно:

  1. Вычисляет `_T2` (среднее по критериям)
  2. Нормализует оценки в `_T3`
  3. Применяет корректировки `_T4`
  4. Распределяет `total_weekly_bonus` пропорционально `_T4`

