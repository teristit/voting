
# API и интеграции системы «Умная премия»

## 1. Авторизация

### 1.1 Telegram WebApp
```bash
POST /api/v1/auth/telegram
Content-Type: application/json

{
  "init_data": "tgWebAppData=query_id=AAHdF6IQAAAAAN0XohDhr8c&user=..."
}
```

**Ответ:**
```json
{
  "status": "success",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "user_id": 123456789,
    "name": "John Doe",
    "role": "user",
    "active": true
  },
  "expires_in": 3600
}
```
* Используется `initData` для верификации пользователя.
* Backend проверяет подпись `hash` и идентифицирует пользователя.
* После успешной проверки создается сессия (JWT или cookie).

### 1.2 Корпоративный аккаунт (опционально)

* OAuth2 / SSO.
* Получение токена доступа для API.

---


## 2. Входные переменные премии (админ)

### 2.1 Описание

Параметры премии задаются **администратором** и сохраняются в контексте текущей сессии голосования.
Они могут быть обновлены в любой момент — при этом новые значения применяются ко всем последующим расчётам.

| Переменная                 | Описание                                        | Пример                                           |
| -------------------------- | ----------------------------------------------- | ------------------------------------------------ |
| `average_weekly_revenue`   | Средняя недельная выручка за последние 3 недели | 3057926.67                                       |
| `participation_multiplier` | Умножитель участия (доля активных участников)   | 0.875                                            |
| `total_weekly_bonus`       | Общая сумма недельной премии                    | 37459.60                                         |
| `participants_info`        | Информация о составе команды                    | `{"total_potential":32,"refused":4,"active":28}` |

---

### 2.2 Эндпоинты для админа

#### Установка или обновление параметров премии

* **URL:** `/api/v1/sessions/{session_id}/bonus-params`
* **Метод:** `POST`
* **Описание:** Установка или изменение параметров премии в рамках активной сессии.
* **Запрос:**

```json
{
  "average_weekly_revenue": 3057926.67,
  "participation_multiplier": 0.875,
  "total_weekly_bonus": 37459.60,
  "participants_info": {
    "total_potential": 32,
    "refused": 4,
    "active": 28
  }
}
```

* **Ответ:**

```json
{
  "status": "success",
  "message": "Параметры премии обновлены"
}
```

#### Получение текущих параметров премии (для фронтенда / расчётов)

* **URL:** `/api/v1/sessions/{session_id}/bonus-params`
* **Метод:** `GET`
* **Описание:** Возвращает актуальные параметры премии, установленные администратором.
* **Ответ:**

```json
{
  "average_weekly_revenue": 3057926.67,
  "participation_multiplier": 0.875,
  "total_weekly_bonus": 37459.60,
  "participants_info": {
    "total_potential": 32,
    "refused": 4,
    "active": 28
  },
  "updated_at": "2025-10-16T12:45:00"
}
```

---

## 3. Эндпоинты фронтенд → backend

### 3.0 Получение текущей сессии (веб/мобильный клиент)

* **URL:** `/api/v1/sessions/current`
* **Метод:** GET
* **Описание:** Получение активной сессии голосования.
* **Ответ:**

```json
{
  "session_id": 17,
  "start_date": "2025-10-20",
  "end_date": "2025-10-26",
  "active": true
}
```

---

### 3.1 Голосование

* **URL:** `/api/v1/votes`
* **Метод:** POST
* **Описание:** Отправка оценок за коллег (включая себя)
* **Запрос:**

```json
{
  "session_id": 17,
  "votes": [
    {"user_id": 101, "score": 8},
    {"user_id": 102, "score": 7},
    {"user_id": 103, "score": 9}
  ]
}
```

* **Ответ:**

```json
{
  "status": "success",
  "message": "Оценки сохранены"
}
```

#### Пояснения:

1. `voter_id` определяется **из аутентификационных данных**, а не из JSON:

   * Telegram WebApp: `user.id` из `initData`
   * Веб: JWT / корпоративная сессия
2. Backend проверяет:

   * Активность сессии (`session_id`)
   * Пользователь ещё не голосовал за этих коллег
   * Голос в диапазоне 0–10
3. После завершения голосования происходит **расчёт промежуточных и итоговых баллов**, аналогично листам `_T1`–`_T4` в Excel:

   * `_T1` – сбор оценок по критериям
   * `_T2` – вычисление средней моды / базовой шкалы
   * `_T3` – нормализация и подсчёт очков
   * `_T4` – финальная корректировка и проверка
4. Итоговая премия вычисляется пропорционально баллам, с учётом `total_weekly_bonus` и `participation_multiplier`.

---

### 3.2 Просмотр результатов (сотрудник)

* **URL:** `/api/v1/results/me`
* **Метод:** GET
* **Описание:** Получение собственного рейтинга и премии
* **Ответ:**

```json
{
  "user_id": 101,
  "average_score": 7.8,
  "rank": 3,
  "total_bonus": 1541.81,
  "votes_given": 5,
  "votes_received": [
    {"from_user_id": 102, "score": 8},
    {"from_user_id": 103, "score": 7}
  ]
}
```

---

### 3.3 Просмотр результатов (админ)

* **URL:** `/api/v1/results/session/{session_id}`
* **Метод:** GET
* **Описание:** Получение всех голосов и распределения премий за сессию
* **Ответ:**

```json
{
  "session_id": 17,
  "results": [
    {
      "user_id": 101,
      "average_score": 7.8,
      "votes_received": 5,
      "total_bonus": 1541.81
    },
    {
      "user_id": 102,
      "average_score": 8.2,
      "votes_received": 5,
      "total_bonus": 1600.45
    }
  ]
}
```

---

## 4. Управление сессиями (админ)

### 4.1 Создание новой сессии

* **URL:** `/api/v1/sessions`
* **Метод:** POST
* **Запрос:**

```json
{
  "start_date": "2025-10-20",
  "end_date": "2025-10-26",
  "active": true
}
```

* **Ответ:**

```json
{
  "status": "success",
  "session_id": 17
}
```

### 4.2 Закрытие сессии

* **URL:** `/api/v1/sessions/{session_id}/close`
* **Метод:** POST

**Запрос:**

```json
{
  "forced": true
}
```
* **Ответ:**

```json
{
  "status": "success",
  "message": "Сессия закрыта",
  "session_id": 17,
  "results_summary": {
    "participants_count": 28,
    "votes_count": 742,
    "average_score": 7.62,
    "total_bonus_distributed": 37459.60
  }
}

```

### 4.3 Повторное открытие сессии

**URL**: `/api/v1/sessions/{session_id}/reopen`  
**Метод**: `POST`  
**Роль**: admin  

**Описание**:  
Позволяет администратору повторно открыть ранее закрытую сессию голосования. Это может потребоваться в случае:
- технических сбоев во время голосования,
- ошибочного досрочного закрытия,
- необходимости добавить голоса от сотрудников, не успевших проголосовать.

**Ограничения**:
- Сессию можно повторно открыть **только в течение 72 часов** после её закрытия.
- После повторного открытия **все голоса, поданные до закрытия, сохраняются**.
- Новые голоса принимаются до окончания исходного периода сессии (`end_date`) **или до нового ручного закрытия**, в зависимости от настроек.
- Если `end_date` уже в прошлом, система автоматически продлевает сессию на 24 часа (до `now() + 24h`), если это не запрещено политикой.

**Запрос**:  
Тело запроса не требуется.

**Ответ (успех)**:
```json
{
  "status": "success",
  "message": "Сессия №35 повторно открыта",
  "new_end_date": "2025-10-18T23:59:59"
}
```

**Ответ (ошибка)**:
```json
{
  "status": "error",
  "code": "SESSION_REOPEN_WINDOW_EXPIRED",
  "message": "Сессию можно повторно открыть только в течение 48 часов после закрытия"
}
```

**Побочные эффекты**:
- В журнал аудита (`/api/v1/logs`) записывается событие:  
  `action: "reopen_session"`, `target_session_id: 35`, `admin_id: …`
- Все активные участники получают уведомление в Telegram:  
  _«Голосование за неделю №35 возобновлено. У вас есть до {new_end_date} для подачи оценок.»_
---

### 4.4 Управление голосами (админ)

Раздел предназначен для корректировки голосов администратором в активных или завершённых сессиях.
Админ может **просматривать**, **изменять** и **удалять** оценки, при этом все действия логируются.

---

#### 4.4.1 Просмотр всех голосов сессии

* **URL:** `/api/v1/sessions/{session_id}/votes`
* **Метод:** `GET`
* **Описание:** Получение списка всех голосов участников в рамках сессии.
* **Доступ:** Только `admin`.

**Ответ:**

```json
{
  "session_id": 17,
  "votes": [
    {
      "vote_id": 551,
      "voter_id": 101,
      "voter_name": "Иван Иванов",
      "target_id": 102,
      "target_name": "Петров Пётр",
      "score": 8,
      "timestamp": "2025-10-20T12:31:00"
    },
    {
      "vote_id": 552,
      "voter_id": 103,
      "target_id": 104,
      "score": 7
    }
  ]
}
```

---

#### 4.4.2 Изменение оценки

* **URL:** `/api/v1/votes/{vote_id}`
* **Метод:** `PATCH`
* **Описание:** Изменение значения оценки в существующем голосе.
* **Доступ:** Только `admin`.

**Запрос:**

```json
{
  "new_score": 9
}
```

**Ответ:**

```json
{
  "status": "success",
  "message": "Оценка обновлена",
  "vote_id": 551,
  "old_score": 8,
  "new_score": 9
}
```

---

#### 4.4.3 Удаление голоса

* **URL:** `/api/v1/votes/{vote_id}`
* **Метод:** `DELETE`
* **Описание:** Удаление голоса из базы данных (исключение из расчётов).
* **Доступ:** Только `admin`.

**Ответ:**

```json
{
  "status": "success",
  "message": "Голос удалён",
  "vote_id": 551
}
```

---

#### 4.4.4 Логирование изменений

Все изменения, внесённые администратором, сохраняются в журнал (`audit_log`) и могут быть просмотрены через отдельный эндпоинт `/api/v1/logs`.

**Пример записи лога:**

```json
{
  "timestamp": "2025-10-22T15:12:00",
  "admin_id": 1,
  "action": "vote_update",
  "details": "Изменён голос vote_id=551: 8 → 9",
  "session_id": 17
}
```

---

#### 4.4.5 Поведение после изменения

1. После каждого изменения или удаления голосов система автоматически:

   * обновляет промежуточные таблицы `_T2–_T4`;
   * пересчитывает результаты (`/results/session/{session_id}`);
   * помечает изменённые голоса флагом `"modified_by_admin": true`.
2. При необходимости админ может вызвать перерасчёт вручную через эндпоинт `/api/v1/results/recalculate/{session_id}` (см. раздел 11.3).
### 4.5 Управление участниками сессии
```bash
# Добавление участников
POST /api/v1/admin/sessions/{session_id}/participants
{
  "user_ids": [101, 102, 103],
  "can_vote": true,
  "can_receive_votes": true,
  "status": "active"
}

# Просмотр участников
GET /api/v1/admin/sessions/{session_id}/participants

# Изменение прав участника
PATCH /api/v1/admin/sessions/{session_id}/participants/{user_id}
{
  "can_vote": false,
  "status": "vacation"
}
```
---

## 5. Управление участниками (админ)

### 5.1 Добавление / обновление сотрудника

* **URL:** `/api/v1/users`
* **Метод:** POST
* **Запрос:**

```json
{
  "user_id": 101,
  "name": "Иван Иванов",
  "active": true
}
```

* **Ответ:**

```json
{
  "status": "success",
  "message": "Пользователь добавлен/обновлён"
}
```

### 5.2 Пометка сотрудника как неактивного

* **URL:** `/api/v1/users/{user_id}/deactivate`
* **Метод:** POST
* **Ответ:**

```json
{
  "status": "success",
  "message": "Пользователь помечен как неактивный"
}
```

### 5.3 Получение участников с фильтрацией
```bash
GET /api/v1/admin/users?active=true&role=user
```

### 5.4 Массовые операции с пользователями
```bash
POST /api/v1/admin/users/bulk
{
  "users": [
    {"user_id": 101, "name": "Иван Иванов", "role": "user"},
    {"user_id": 102, "name": "Петр Петров", "role": "manager"}
  ]
}
```
---

## 6. Экспорт данных (админ)

* **URL:** `/api/v1/export/session/{session_id}`
* **Метод:** GET
* **Описание:** Получение XLSX или CSV с итогами голосования и премиями
* **Ответ:** файл для скачивания, включая расчётные колонки:

  * `ФИО`
  * `Средняя оценка`
  * `Итоговая премия`
  * `Ранг`
  * `Баллы по критериям`

---

## 7. Безопасность

* Все эндпоинты требуют аутентификации (JWT или сессия)
* Разграничение ролей: сотрудник / админ
* Валидация всех входных данных
* Проверка подписи Telegram для предотвращения подделки голосов
* Проверка `session_id` на активность перед принятием голосов

---

## 8. Интеграции

* Telegram Mini App → Frontend → Backend API
* Опциональная интеграция с корпоративной SSO
* Экспорт данных для бухгалтерии и HR-систем (XLSX/CSV)
* Асинхронные уведомления через Telegram / email

---

## 9. Пример потока голосования

1. Frontend делает GET `/sessions/current` → получает `session_id`.
2. Пользователь открывает форму голосования и ставит оценки коллегам.
3. Frontend отправляет POST `/votes` с `session_id`, оценками.
4. Backend:

   * Определяет `voter_id`
   * Проверяет активность сессии и участников
   * Сохраняет оценки
5. После окончания голосования:
   * Выполняет расчёт промежуточных таблиц `_T1`–`_T4`
   * Вычисляет итоговую премию пропорционально баллам и `total_weekly_bonus` 
   * админ получает GET `/results/session/{session_id}` и может экспортировать XLSX/CSV.

---
## 10. Структура JSON для расчёта премий (_T1–_T4)


### 1. Общие параметры

```json
{
  "average_weekly_revenue": 3057926.67,
  "participation_multiplier": 0.875,
  "total_weekly_bonus": 37459.60,
  "participants_info": {
    "total_potential": 32,
    "refused": 4,
    "active": 28
  }
}
```

---

### 2. Сырые оценки (`_T1`)

* Оценки сотрудников по различным критериям (участие, присутствие, качество и т.д.)
* Каждому участнику соответствует словарь с оценками по другим участникам.

```json
{
  "T1": {
    "Александров Евгений": {
      "Александров Евгений": 10,
      "Алексеев Дмитрий": 0,
      "Батманов Павел": 5
    },
    "Алексеев Дмитрий": {
      "Александров Евгений": 0,
      "Алексеев Дмитрий": 0,
      "Батманов Павел": 0
    },
    "Батманов Павел": {
      "Александров Евгений": 5,
      "Алексеев Дмитрий": 0,
      "Батманов Павел": 5
    }
  }
}
```

---

### 3. Средние значения и базовая шкала (`_T2`)

* Здесь вычисляется средняя модальная оценка для каждого участника.

```json
{
  "T2": {
    "Александров Евгений": 7.5,
    "Алексеев Дмитрий": 0,
    "Батманов Павел": 5.0
  }
}
```

* Эти значения используются для нормализации итоговых баллов.

---

### 4. Нормализованные баллы (`_T3`)

* Переводим оценки в единый формат для суммирования и пропорционального распределения премии.

```json
{
  "T3": {
    "Александров Евгений": 8.5,
    "Алексеев Дмитрий": 0,
    "Батманов Павел": 6.0
  }
}
```

---

### 5. Финальные корректировки (`_T4`)

* Применение дополнительных коэффициентов (например, участие, корректировка за отсутствие)

```json
{
  "T4": {
    "Александров Евгений": 8.5,
    "Алексеев Дмитрий": 0,
    "Батманов Павел": 5.5
  }
}
```

---

### 6. Итоговая премия

* Распределение `total_weekly_bonus` пропорционально итоговым баллам `_T4`.

```json
{
  "final_bonus": {
    "Александров Евгений": 1541.81,
    "Алексеев Дмитрий": 0,
    "Батманов Павел": 1445.45
  }
}
```

---

### 7. Пример полного запроса API для расчёта премии

```json
{
  "session_id": 17,
  "participants_info": {
    "average_weekly_revenue": 3057926.67,
    "participation_multiplier": 0.875,
    "total_weekly_bonus": 37459.60,
    "participants": {"total_potential":32,"refused":4,"active":28}
  },
  "votes": {
    "T1": {
      "Александров Евгений": {"Александров Евгений":10,"Алексеев Дмитрий":0,"Батманов Павел":5},
      "Алексеев Дмитрий": {"Александров Евгений":0,"Алексеев Дмитрий":0,"Батманов Павел":0},
      "Батманов Павел": {"Александров Евгений":5,"Алексеев Дмитрий":0,"Батманов Павел":5}
    }
  }
}
```

* Backend принимает этот JSON и последовательно:

  1. Вычисляет `_T2` (среднее по критериям)
  2. Нормализует оценки в `_T3`
  3. Применяет корректировки `_T4`
  4. Распределяет `total_weekly_bonus` пропорционально `_T4`


## 11. Логирование и аудит

### 11.1 Назначение

Система ведёт журнал всех действий администраторов и ключевых событий пользователей.
Это необходимо для прозрачности, аудита и диагностики возможных ошибок.

### 11.2 Эндпоинт для получения журнала действий

* **URL:** `/api/v1/logs`

* **Метод:** `GET`

* **Описание:** Получение записей о действиях пользователей и администраторов.

* **Параметры запроса (опциональные):**

  * `user_id` — фильтр по пользователю
  * `session_id` — фильтр по сессии
  * `date_from`, `date_to` — диапазон дат

* **Пример запроса:**

```
GET /api/v1/logs?session_id=17&date_from=2025-10-10
```

* **Ответ:**

```json
{
  "logs": [
    {
      "timestamp": "2025-10-17T09:41:00",
      "user": "admin",
      "action": "update_bonus_params",
      "details": "Изменены total_weekly_bonus и participation_multiplier",
      "session_id": 17
    },
    {
      "timestamp": "2025-10-17T10:02:00",
      "user": "Александров Евгений",
      "action": "vote_submit",
      "details": "Отправлены оценки 3 коллегам",
      "session_id": 17
    }
  ]
}
```

---

### 11.3 Типы действий

| Тип события           | Описание                                   |
| --------------------- | ------------------------------------------ |
| `vote_submit`         | Сотрудник отправил голоса                  |
| `vote_update`         | Попытка изменения уже отправленных голосов |
| `session_open`        | Создание новой недели голосования          |
| `session_close`       | Завершение недели                          |
| `user_status_change`  | Админ изменил статус участника             |
| `update_bonus_params` | Изменены параметры премии                  |
| `export_results`      | Выгрузка данных в XLSX/CSV                 |

---

## 12. Настройки системы

### 12.1 Назначение

Администратор может изменять глобальные параметры расчёта, не привязанные к конкретной сессии — например, вес самооценки, шкалу оценок или длительность голосования.

---

### 12.2 Получение текущих настроек

* **URL:** `/api/v1/settings`

* **Метод:** `GET`

* **Описание:** Возвращает все глобальные параметры системы.

* **Ответ:**

```json
{
  "vote_scale_min": 0,
  "vote_scale_max": 10,
  "self_vote_weight": 0.8,
  "min_votes_required": 3,
  "session_duration_days": 7
}
```

---

### 12.3 Обновление настроек

* **URL:** `/api/v1/settings`
* **Метод:** `POST`
* **Описание:** Изменение глобальных параметров системы.
* **Запрос:**

```json
{
  "self_vote_weight": 0.8,
  "vote_scale_min": 0,
  "vote_scale_max": 10,
  "min_votes_required": 3,
  "session_duration_days": 7
}
```

* **Ответ:**

```json
{
  "status": "success",
  "message": "Настройки системы обновлены"
}
```

---

## 13. Ошибки и коды ответов

### 13.1 Общие коды состояния

| Код | Статус                | Описание                                   |
| --- | --------------------- | ------------------------------------------ |
| 200 | OK                    | Успешный запрос                            |
| 201 | Created               | Ресурс создан                              |
| 204 | No Content            | Успешно, без контента                      |
| 400 | Bad Request           | Ошибка валидации данных                    |
| 401 | Unauthorized          | Неавторизованный доступ                    |
| 403 | Forbidden             | Недостаточно прав                          |
| 404 | Not Found             | Ресурс не найден                           |
| 409 | Conflict              | Конфликт (например, повторное голосование) |
| 422 | Unprocessable Entity  | Некорректные данные запроса                |
| 500 | Internal Server Error | Ошибка сервера                             |

---

### 13.2 Формат ошибки

* **Пример:**

```json
{
  "status": "error",
  "code": 409,
  "message": "Пользователь уже проголосовал за этого коллегу в текущей сессии"
}
```

---

### 13.3 Специальные случаи ошибок

| Код | Тип                    | Пример сообщения                                  |
| --- | ---------------------- | ------------------------------------------------- |
| 400 | `validation_error`     | "Некорректное значение оценки (должно быть 0–10)" |
| 401 | `auth_required`        | "Требуется авторизация через Telegram"            |
| 403 | `access_denied`        | "Доступ разрешён только администраторам"          |
| 404 | `session_not_found`    | "Активная сессия не найдена"                      |
| 409 | `duplicate_vote`       | "Вы уже проголосовали за этого коллегу"           |
| 422 | `missing_bonus_params` | "Не заданы параметры премии для текущей сессии"   |

---