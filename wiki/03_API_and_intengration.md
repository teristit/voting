# API и интеграции системы "Умная Премия" (Telegram Bot версия)

Данный документ описывает работу системы при использовании Telegram Bot (без Telegram Mini App/WebApp). В этом режиме пользователь взаимодействует с ботом через команды и кнопки, а фронтенд (веб‑сайт) может быть опциональным.

## 1. Аутентификация

### 1.1. Подход
- Отказ от WebApp initData. Вместо этого используется классический бот:
  - Пользователь запускает бота: /start
  - Бот получает `telegram_id`, `username`, `first_name/last_name`
  - Бэкенд создаёт/обновляет пользователя по `telegram_id`
  - Для веб‑сайта (если используется) бот может выдавать одноразовую ссылку авторизации (magic link) с JWT (см. 1.3)

### 1.2. API: вход через бота
- Бот обращается к backend REST API для регистрации/логина пользователя по `telegram_id`:
  - `POST /api/v1/auth/bot-login`
    - body: `{ telegram_id, username, name }`
    - response: `{ status, token, user, expires_in }`
- Бот хранит у себя токен не требуется — взаимодействие идёт через Telegram Bot API. Токен нужен только для веб‑интерфейса (если пользователь открывает сайт из бота).

### 1.3. Magic link (опционально)
- `POST /api/v1/auth/magic-link`
  - body: `{ telegram_id }`
  - ответ: одноразовая ссылка вида: `https://site/login?token=...` (JWT c коротким TTL)
- Переход по ссылке авторизует пользователя в вебе без Mini App.

## 2. Пользовательские сценарии через бота

### 2.1. Команды
- `/start` — привязка аккаунта, приветствие
- `/help` — справка
- `/vote` — перейти к голосованию (бот отправляет список участников с инлайн‑кнопками/меню ввода оценок)
- `/results` — получить мои результаты текущей сессии или общий рейтинг (картинка/таблица)
- `/me` — профиль пользователя

### 2.2. Голосование через бот
- Бот получает список доступных для голосования участников (backend: `GET /api/v1/sessions/current`, `GET /api/v1/sessions/{id}/participants`)
- Отправляет пользователю инлайн‑кнопки с оценками 0–10 для каждого участника (или пошагово)
- По клику:
  - `POST /api/v1/votes` с телом `{ session_id, votes: [{ target_id, score, comment? }] }`
- Подтверждение: бот присылает сообщение «Голоса учтены»

### 2.3. Результаты
- `GET /api/v1/results/me` — бот форматирует текстом/картинкой (top‑N, моя позиция)
- `GET /api/v1/results/session/{id}` — общий рейтинг, можно отправить как красиво отформатированный текст/изображение/файл

## 3. Администрирование через бота (опционально)
- Команды только для админов (проверка роли на backend по telegram_id):
  - `/admin_open_session` — открыть новую сессию
  - `/admin_close_session` — закрыть текущую
  - `/admin_reopen_session` — переоткрыть в течение окна X часов
  - `/admin_bonus` — установить параметры бонусов (бот запросит цифры пошагово)
  - `/admin_export` — получить XLSX/CSV файлы (бот отправит как документ)

## 4. Архитектура изменений

- Бэк снимает зависимость от WebApp initData (удалить/законсервировать routes/auth Telegram WebApp)
- Добавить эндпоинты:
  - `POST /api/v1/auth/bot-login` — аутентификация по `telegram_id`
  - `POST /api/v1/auth/magic-link` — выдача одноразовой ссылки для веба (необязательно)
- Валидация: по токену бота (на стороне самого бота) не нужна для backend — backend доверяет `telegram_id` из запроса от бота, если используется сервер‑к серверу (рекомендуется подписывать запросы бота секретом BOT_API_SECRET)

## 5. Безопасность

- Рекомендация: при сервер‑к‑сервер интеграции между ботом и backend использовать заголовок `X-Bot-Signature` с HMAC‑подписью тела запроса (секрет BOT_API_SECRET)
- Ограничить IP или использовать VPN в локальной сети
- Все пользовательские действия логируются (audit)

## 6. Изменения в UX

- Веб‑фронтенд становится опциональным (используется для расширенной аналитики/таблиц)
- Основное взаимодействие переносится в диалог с ботом (инлайн‑кнопки, команды)
- Поддержка локальной сети: бот и backend могут работать в одной сети, без публичного домена

## 7. Примеры запросов

### 7.1. Бот‑логин
```bash
POST /api/v1/auth/bot-login
Content-Type: application/json
X-Bot-Signature: <HMAC>

{
  "telegram_id": 123456789,
  "username": "john_doe",
  "name": "John Doe"
}
```
Ответ:
```json
{ "status": "success", "token": "<JWT>", "user": {"user_id": 1, "name": "John Doe", "role": "user"}, "expires_in": 3600 }
```

### 7.2. Отправка голосов
```bash
POST /api/v1/votes
Authorization: Bearer <JWT>
Content-Type: application/json

{
  "session_id": 18,
  "votes": [
    { "target_id": 102, "score": 8 },
    { "target_id": 103, "score": 6, "comment": "Отличная работа" }
  ]
}
```

### 7.3. Мои результаты
```bash
GET /api/v1/results/me
Authorization: Bearer <JWT>
```

## 8. Миграция с Mini App на Bot

1) Отключить зависимость от Telegram WebApp SDK во фронтенде (оставить опционально)
2) Добавить эндпоинты bot-login/magic-link
3) Написать Telegram Bot (python-telegram-bot/aiogram/grammY и т. п.)
4) Протестировать голосование и результаты через бот
5) В дальнейшем при необходимости включить фронт для аналитики и загрузок
