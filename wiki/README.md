# Переход от Telegram Mini App к Telegram Bot

Цель: упростить запуск без публичного домена и оставить **веб‑интерфейс** для голосования/администрирования в локальной сети, а взаимодействие в Telegram перевести на **бота** (команды, кнопки, deep‑links).

## Архитектура канала взаимодействия

- Telegram Bot (чат‑интерфейс):
  - Команды: /start, /help, /vote, /results, /me, /admin (для админов)
  - Кнопки (inline keyboard): быстрые действия (Проголосовать, Мои результаты, Открыть веб‑панель)
  - Deep‑links: выдача персональной ссылки на локальный веб (LAN), например `http://LAN_IP:5173/?t=<jwt>` или `http://LAN_IP:5173/login?code=<one_time>`
- Веб‑интерфейс (локальная сеть):
  - Доступ по `http://LAN_IP:5173` (frontend) и `http://LAN_IP:5000` (backend)
  - Полноценные UI: голосование, результаты, админка
  - Аутентификация: через одноразовый код/токен от бота (без Mini App initData)

## Аутентификация без Mini App

1) Пользователь пишет боту → нажимает кнопку «Открыть веб‑панель».
2) Бот генерирует одноразовый код/ссылку (TTL 5–10 минут), привязанную к user_id Telegram:
   - В БД создаётся запись OneTimeLogin(code, telegram_id, expires_at, used=false)
   - Бот отправляет ссылку: `http://LAN_IP:5173/login?code=<CODE>`
3) Фронтенд на маршруте /login читает `code` и вызывает бекенд `POST /api/v1/auth/code-login`.
4) Бекенд валидирует code → отмечает used=true → создаёт JWT → возвращает user и token.
5) Фронтенд сохраняет токен и перенаправляет в приложение.

Дополнительно (вариант): можно сразу выдавать **подписанный JWT** вместо кода (короче цепочка), но одноразовый код безопаснее в LAN.

## Изменения в backend

Новые эндпоинты:
- `POST /api/v1/auth/code-login` — вход по одноразовому коду (телеграм‑ботом выданному)
- `POST /api/v1/auth/generate-code` — (только для бота/сервиса) создать одноразовый код по telegram_id

Новые сущности:
- OneTimeLogin: id, code, telegram_id, expires_at, used (bool), created_at

Логика:
- Бот (через service token/API key) вызывает `generate-code` для telegram_id
- Пользователь переходит в веб по ссылке с code
- Бекенд валидирует и выпускает JWT

Безопасность:
- Коды одноразовые, живут 5–10 минут
- Ограничение частоты генерации по telegram_id (rate‑limit)
- Для `generate-code` использовать серверный ключ X-API-Key

## Изменения во frontend

- Добавить маршрут `/login` (страница, которая читает ?code=… и вызывает `/auth/code-login`)
- В auth store поддержать сценарий входа по коду
- В UI убрать требование наличия Telegram WebApp initData; оставить кнопку «Войти через код»

## Изменения в боте

Бот команды (пример):
- `/start` — привязка telegram_id к пользователю (создание при первом входе), показать меню
- `/vote` — показать текущее состояние голосования + кнопка «Открыть веб‑панель» (deep‑link)
- `/results` — краткие мои результаты + кнопка «Открыть веб‑панель»
- `/admin` — опции для админа: «Открыть веб‑админку», «Создать сессию», «Экспорт» (по мере готовности API)

Inline‑кнопки:
- «Открыть веб‑панель» — бот вызывает `generate-code` и отправляет ссылку с кодом

## Потоки действий

### Пользователь
1) Открывает бота → жмёт «Открыть веб‑панель»
2) Получает ссылку вида `http://LAN_IP:5173/login?code=XYZ`
3) Переходит по ссылке в локальной сети → попадает в приложение уже аутентифицированным

### Администратор
- Через веб‑админку в локальной сети управляет сессиями/участниками/экспортом
- Через бота может получать уведомления и быстрые ссылки в веб‑админку

## Локальная сеть

- Backend: http://LAN_IP:5000 (слушает 0.0.0.0)
- Frontend: http://LAN_IP:5173 (Vite `npm run dev -- --host`)
- Bot: не требует публичного домена, если ботом пользоваться только для генерации одноразовых ссылок в пределах LAN (ссылки будут на LAN_IP). Если планируются пуш‑уведомления снаружи — потребуется белый IP/прокси или long polling.

## Миграция

1) Отключить проверку Telegram WebApp initData в `/auth/telegram` (либо оставить для совместимости)
2) Добавить `OneTimeLogin` модель и миграцию (для SQLite — create_all; для Postgres позже — Alembic)
3) Реализовать `POST /auth/generate-code` и `POST /auth/code-login`
4) Обновить фронтенд (страница /login, auth store)
5) Добавить бота (Long Polling) с командами и inline‑кнопками

## Примечания по безопасности
- Коды одноразовые и короткоживущие
- Логи действий (audit) фиксируют входы по коду
- Для LAN ограничить доступ к API из внешней сети (фаерволл)

---

Дальше в этом wiki будут детальные инструкции по настройке бота, эндпоинтов и фронтенда под вход по коду.