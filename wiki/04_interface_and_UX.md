# 04_Интерфейсы_и_UX

## 1. Общие принципы UX

* Простой и понятный интерфейс для сотрудников и администраторов.
* Минимум кликов для основных действий: голосование, просмотр результатов, экспорт данных.
* Мобильная адаптация — интерфейс должен работать в Telegram Mini App и веб-браузере.
* Чёткая индикация текущей сессии и статуса голосования.
* Подтверждения действий и визуальная обратная связь (например, после отправки голосов).

---

## 2. Основные экраны

### 2.1 Экран голосования (сотрудник)

* Список коллег с полями для выставления оценок (0–10).
* Кнопка "Отправить" активна только после заполнения всех обязательных оценок.
* После отправки голосов появляется уведомление об успешной отправке.
* При наличии ограничений (например, уже голосовал) выводятся подсказки.

### 2.2 Экран результатов (сотрудник)

* Отображение собственного среднего балла, ранга и итоговой премии.
* Список полученных оценок от коллег.
* Визуализация: график или таблица для наглядного понимания распределения баллов.

### 2.3 Экран админа

* Управление сессиями: создание, закрытие, повторное открытие.
* Управление участниками: добавление, деактивация.
* Управление параметрами премии: установка/обновление входных переменных.
* Просмотр и корректировка голосов.
* Экспорт данных (XLSX/CSV) и журнал аудита.

---

## 3. API и интеграции системы «Умная премия»

### 3.1 Авторизация

#### 3.1.1 Telegram WebApp

* Используется `initData` для верификации пользователя.
* Backend проверяет подпись `hash` и идентифицирует пользователя.
* После успешной проверки создается сессия (JWT или cookie).



---

### 3.2 Входные переменные премии (админ)

* Параметры премии задаются администратором и могут обновляться в любое время.
* Новые значения применяются ко всем последующим расчётам одной сессии.

| Переменная                 | Описание                                        | Пример                                           |
| -------------------------- | ----------------------------------------------- | ------------------------------------------------ |
| `average_weekly_revenue`   | Средняя недельная выручка за последние 3 недели | 3057926.67                                       |
| `participation_multiplier` | Умножитель участия                              | 0.875                                            |
| `total_weekly_bonus`       | Общая сумма недельной премии                    | 37459.60                                         |
| `participants_info`        | Информация о составе команды                    | `{"total_potential":32,"refused":4,"active":28}` |

#### Эндпоинты для админа

* **POST** `/api/v1/sessions/{session_id}/bonus-params` – установка или обновление параметров.
* **GET** `/api/v1/sessions/{session_id}/bonus-params` – получение текущих параметров.

---

### 3.3 Голосование и результаты

* **GET** `/api/v1/sessions/current` – получение активной сессии.
* **POST** `/api/v1/votes` – отправка голосов.
* **GET** `/api/v1/results/me` – просмотр собственных результатов.
* **GET** `/api/v1/results/session/{session_id}` – просмотр результатов всей сессии (админ).

---

### 3.4 Управление сессиями (админ)

* **POST** `/api/v1/sessions` – создание новой сессии.
* **POST** `/api/v1/sessions/{session_id}/close` – закрытие сессии.
* **POST** `/api/v1/sessions/{session_id}/reopen` – повторное открытие сессии (ограничено 72 часами).
* **GET** `/api/v1/sessions/{session_id}/votes` – просмотр всех голосов.
* **PATCH** `/api/v1/votes/{vote_id}` – изменение оценки.
* **DELETE** `/api/v1/votes/{vote_id}` – удаление голоса.

---

### 3.5 Управление участниками (админ)

* **POST** `/api/v1/users` – добавление/обновление сотрудника.
* **POST** `/api/v1/users/{user_id}/deactivate` – деактивация сотрудника.

---

### 3.6 Экспорт и отчёты

* **GET** `/api/v1/export/session/{session_id}` – XLSX/CSV с результатами голосования и премиями.

---

### 3.7 Настройки системы (глобальные)

* **GET** `/api/v1/settings` – получение текущих настроек.
* **POST** `/api/v1/settings` – обновление глобальных параметров (например, шкала оценок, вес самооценки, длительность сессии).

---

### 3.8 Логирование и аудит

* Все действия админов и ключевые события пользователей логируются.
* **GET** `/api/v1/logs` – получение журнала действий с фильтрацией по пользователю, сессии и диапазону дат.
* Типы событий: `vote_submit`, `vote_update`, `session_open`, `session_close`, `user_status_change`, `update_bonus_params`, `export_results`.

---

### 3.9 Ошибки и коды ответов

| Код | Статус                | Описание                                   |
| --- | --------------------- | ------------------------------------------ |
| 200 | OK                    | Успешный запрос                            |
| 201 | Created               | Ресурс создан                              |
| 400 | Bad Request           | Ошибка валидации данных                    |
| 401 | Unauthorized          | Неавторизованный доступ                    |
| 403 | Forbidden             | Недостаточно прав                          |
| 404 | Not Found             | Ресурс не найден                           |
| 409 | Conflict              | Конфликт (например, повторное голосование) |
| 422 | Unprocessable Entity  | Некорректные данные запроса                |
| 500 | Internal Server Error | Ошибка сервера                             |

*Примеры формата ошибок описаны в разделе 13 оригинального документа API.*

---

## 4. Пример потока голосования

1. Frontend делает **GET** `/sessions/current` → получает `session_id`.
2. Пользователь выставляет оценки коллегам.
3. Frontend отправляет **POST** `/votes`.
4. Backend проверяет валидность, сохраняет голоса, пересчитывает промежуточные таблицы `_T1–_T4`.
5. Админ может экспортировать результаты или пересчитать вручную.

---

## 5. Расчёт премий (_T1–_T4)

1. `_T1` – сбор оценок.
2. `_T2` – средняя модальная оценка / базовая шкала.
3. `_T3` – нормализация и суммирование баллов.
4. `_T4` – финальные корректировки (коэффициенты участия, отсутствие и т.д.).
5. Итоговая премия распределяется пропорционально `_T4` с учётом `total_weekly_bonus`.

---

## 6. Интеграции

* Telegram Mini App → Frontend → Backend API.
* Экспорт данных для бухгалтерии и HR.
* Асинхронные уведомления через Telegram / email.
